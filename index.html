<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>বাংলাদেশের গণ অধিকার</title>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;600;700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">

    <!-- Main CSS -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- মেইন হেডার -->
    <header class="site-header">
        <div class="container">
            <h1 class="site-title">বাংলাদেশের গণ অধিকার</h1>
            <p class="site-subtitle">
                একটি অনানুষ্ঠানিক ভোট প্ল্যাটফর্ম 
            </p>
        </div>
    </header>

    <!-- স্ক্রলিং টিকার -->
    <section class="vote-ticker">
        <div class="ticker-track">
            <span class="ticker-item">
                আপনার একটি সঠিক ভোট উন্নয়ন, ন্যায়বিচার আর গণতন্ত্রকে শক্ত করে।
                ভেবে ভোট দিন, দায়িত্ব নিয়ে ভোট দিন।
                দেশ গড়ার প্রথম পদক্ষেপই হলো সঠিক ভোট।
                ভোট আপনার অধিকার—এটা সচেতনভাবে ব্যবহার করুন।
                আপনার ভোট দেশের ভবিষ্যৎ প্রজন্মকে নিরাপদ করতে পারে।
                দল নয়, মানুষ ও দেশের স্বার্থ দেখে ভোট দিন।
                সৎ নেতৃত্ব নির্বাচন করুন, দুর্নীতিমুক্ত ভবিষ্যৎ গড়ুন।
                আপনার ভোট—আপনার শক্তি, দেশ গড়ার চাবিকাঠি।
                যে প্রার্থী মানুষের পাশে থাকে, তাকে ভোট দিন।
            </span>
        </div>
    </section>

    <!-- ভোট সেকশন -->
    <main class="main-area">
        <section class="form-card container">
            <h2 class="vote-title">আপনার মতামত দিন</h2>
            <p class="vote-subtitle">
                যে দল/প্রার্থীকে সমর্থন করেন, তার মার্কায় ক্লিক করে ভোট দিন। একজন ভোটার একবারই ভোট দিতে পারবেন।
            </p>
            <p class="vote-result">আপনি এখনও কাউকে ভোট দেননি।</p>

            <div class="candidate-grid">

                <!-- প্রার্থী ১ -->
                <article class="candidate-card">
                    <div class="symbol-circle">
                        <img src="Screenshot 2025-11-23 172310.png" alt="BNP মার্কা">
                    </div>
                    <h3 class="candidate-name">BNP</h3>
                    <p class="live-count" data-candidate="BNP">
                        মোট ভোট: <span class="count">0</span>
                    </p>
                    <button class="vote-btn" data-name="BNP">☝ ভোট দিন</button>
                </article>

                <!-- প্রার্থী ২ -->
                <article class="candidate-card">
                    <div class="symbol-circle">
                        <img src="Screenshot 2025-11-23 172446.png" alt="বাংলাদেশ জামায়াতে ইসলামী মার্কা">
                    </div>
                    <h3 class="candidate-name">বাংলাদেশ জামায়াতে ইসলামী</h3>
                    <p class="live-count" data-candidate="বাংলাদেশ জামায়াতে ইসলামী">
                        মোট ভোট: <span class="count">0</span>
                    </p>
                    <button class="vote-btn" data-name="বাংলাদেশ জামায়াতে ইসলামী">☝ ভোট দিন</button>
                </article>

                <!-- প্রার্থী ৩ -->
                <article class="candidate-card">
                    <div class="symbol-circle">
                        <img src="Screenshot 2025-11-23 172706.png" alt="আওয়ামী লীগ মার্কা">
                    </div>
                    <h3 class="candidate-name">আওয়ামী লীগ</h3>
                    <p class="live-count" data-candidate="আওয়ামী লীগ">
                        মোট ভোট: <span class="count">0</span>
                    </p>
                    <button class="vote-btn" data-name="আওয়ামী লীগ">☝ ভোট দিন</button>
                </article>

                <!-- প্রার্থী ৪ -->
                <article class="candidate-card">
                    <div class="symbol-circle">
                        <img src="Screenshot 2025-11-23 172224.png" alt="NCP মার্কা">
                    </div>
                    <h3 class="candidate-name">NCP</h3>
                    <p class="live-count" data-candidate="NCP">
                        মোট ভোট: <span class="count">0</span>
                    </p>
                    <button class="vote-btn" data-name="NCP">☝ ভোট দিন</button>
                </article>

                <!-- প্রার্থী ৫ -->
                <article class="candidate-card">
                    <div class="symbol-circle">
                        <img src="Screenshot 2025-11-23 172626.png" alt="ইসলামী আন্দোলন মার্কা">
                    </div>
                    <h3 class="candidate-name">ইসলামী আন্দোলন</h3>
                    <p class="live-count" data-candidate="ইসলামী আন্দোলন">
                        মোট ভোট: <span class="count">0</span>
                    </p>
                    <button class="vote-btn" data-name="ইসলামী আন্দোলন">☝ ভোট দিন</button>
                </article>

            </div>
        </section>
    </main>

    <!-- ফুটার -->
    <footer class="site-footer">
        <div class="container footer-inner">
            <p>© বাংলাদেশের গণ অধিকার ২০২৫ </p>
            <p class="footer-credit">Designer &amp; Developer: Murad Ahmmed</p>
        </div>
    </footer>

    <!-- ফিঙ্গারপ্রিন্ট পপআপ -->
    <div class="fp-overlay" id="fpOverlay">
        <div class="fp-modal">
            <h3 class="fp-title">ফিঙ্গারপ্রিন্ট দিয়ে ভোট নিশ্চিত করুন</h3>
            <div class="fp-icon-area" id="fpIconArea">
                <div class="fp-fingerprint"></div>
                <p class="fp-status-text" id="fpStatusText">ফিঙ্গারপ্রিন্ট দিন...</p>
            </div>
            <button class="fp-cancel-btn" id="fpCancelBtn">বাতিল করুন</button>
        </div>
    </div>

    <!-- ভোট + এক ডিভাইস এক ভোট + JSONBin লাইভ কাউন্ট -->
    <script>
        // =========================
        //   JSONBin CONFIG
        // =========================
        const BIN_ID  = "6936e928d0ea881f401aedf4";
        const API_KEY = "$2a$10$UbEVKrlYPHCwuSQfgBbgv.IkD3ajeDCX9m5bmGu8/hSWrdDAnJGEK";
        const API_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;

        // এক ডিভাইস এক ভোট
        const STORAGE_KEY = "bdvote_hasVoted_v1";

        let pendingCandidateName = null;
        let pendingButton = null;
        let hasVoted = false;
        let isSubmitting = false;

        // =========================
        //   JSONBin থেকে ভোট আনা
        // =========================
        async function loadVotes() {
            try {
                const res = await fetch(`${API_URL}/latest?meta=false`, {
                    headers: {
                        "X-Access-Key": API_KEY
                    }
                });

                if (!res.ok) {
                    const txt = await res.text();
                    console.error("Load votes failed:", res.status, txt);
                    return;
                }

                // meta=false দিলে সরাসরি record পাবে
                const data = await res.json();

                const defaults = {
                    "BNP": 0,
                    "বাংলাদেশ জামায়াতে ইসলামী": 0,
                    "আওয়ামী লীগ": 0,
                    "NCP": 0,
                    "ইসলামী আন্দোলন": 0
                };
                const votes = Object.assign({}, defaults, data);

                document.querySelectorAll(".live-count").forEach(el => {
                    const name = el.getAttribute("data-candidate");
                    const span = el.querySelector(".count");
                    if (!span) return;
                    span.textContent = votes[name] ?? 0;
                });

            } catch (err) {
                console.error("loadVotes error:", err);
            }
        }

        // =========================
        //   JSONBin এ ভোট লিখা
        // =========================
        async function sendVoteToAPI(candidateName) {
            if (isSubmitting) return;
            isSubmitting = true;

            try {
                // আগে current votes আনবো
                const resGet = await fetch(`${API_URL}/latest?meta=false`, {
                    headers: { "X-Access-Key": API_KEY }
                });

                if (!resGet.ok) {
                    const txt = await resGet.text();
                    console.error("Read error:", resGet.status, txt);
                    isSubmitting = false;
                    return;
                }

                const data = await resGet.json();

                const defaults = {
                    "BNP": 0,
                    "বাংলাদেশ জামায়াতে ইসলামী": 0,
                    "আওয়ামী লীগ": 0,
                    "NCP": 0,
                    "ইসলামী আন্দোলন": 0
                };
                const votes = Object.assign({}, defaults, data);

                votes[candidateName] = Number(votes[candidateName] || 0) + 1;

                // এখন PUT করে আপডেট
                const resPut = await fetch(API_URL, {
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json",
                        "X-Access-Key": API_KEY
                    },
                    body: JSON.stringify(votes)
                });

                if (!resPut.ok) {
                    const txt = await resPut.text();
                    console.error("Update error:", resPut.status, txt);
                    return;
                }

                // সফল হলে UI রিফ্রেশ
                await loadVotes();

            } catch (err) {
                console.error("sendVoteToAPI error:", err);
            } finally {
                isSubmitting = false;
            }
        }

        // =========================
        //   আগের ভোট স্টেট (localStorage)
        // =========================
        function initPreviousVoteState() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (!saved) return;

            try {
                const obj = JSON.parse(saved);
                if (obj && obj.voted && obj.candidate) {
                    hasVoted = true;

                    document.querySelectorAll(".vote-btn").forEach(b => {
                        b.disabled = true;
                        b.classList.add("vote-btn-disabled");
                        if (b.getAttribute("data-name") === obj.candidate) {
                            b.classList.add("voted");
                        }
                    });

                    const result = document.querySelector(".vote-result");
                    if (result) {
                        result.textContent =
                            'আপনি আগে "' + obj.candidate +
                            '" কে ভোট দিয়েছেন (এই ডিভাইস থেকে আবার ভোট দেওয়া যাবে না)।';
                    }
                }
            } catch (e) {
                console.error("LocalStorage parse error:", e);
            }
        }

        // =========================
        //   Vote button click
        // =========================
        function setupVoteButtons() {
            document.querySelectorAll(".vote-btn").forEach(btn => {
                btn.addEventListener("click", function () {
                    if (hasVoted) {
                        alert("আপনি ইতিমধ্যে এই ডিভাইস থেকে ভোট দিয়েছেন। আবার ভোট দিতে পারবেন না।");
                        return;
                    }

                    pendingCandidateName = this.getAttribute("data-name");
                    pendingButton = this;

                    const iconArea = document.getElementById("fpIconArea");
                    iconArea.classList.remove("fp-scanning", "fp-success");
                    document.getElementById("fpStatusText").textContent = "ফিঙ্গারপ্রিন্ট দিন...";

                    document.getElementById("fpOverlay").classList.add("show");
                });
            });
        }

        // =========================
        //   Fingerprint popup
        // =========================
        function setupFingerprintPopup() {
            const iconArea  = document.getElementById("fpIconArea");
            const statusTxt = document.getElementById("fpStatusText");
            const overlay   = document.getElementById("fpOverlay");
            const cancelBtn = document.getElementById("fpCancelBtn");

            iconArea.addEventListener("click", function () {
                iconArea.classList.add("fp-scanning");
                statusTxt.textContent = "স্ক্যান হচ্ছে...";

                setTimeout(async function () {
                    iconArea.classList.remove("fp-scanning");
                    iconArea.classList.add("fp-success");
                    statusTxt.textContent = "ভোট রেকর্ড হয়েছে।";

                    if (!pendingCandidateName) return;

                    // এই ডিভাইসে ভোট শেষ
                    hasVoted = true;
                    localStorage.setItem(
                        STORAGE_KEY,
                        JSON.stringify({ voted: true, candidate: pendingCandidateName })
                    );

                    // API তে ভোট পাঠাও
                    await sendVoteToAPI(pendingCandidateName);

                    // সব বাটন lock + voted ক্লাস
                    document.querySelectorAll(".vote-btn").forEach(b => {
                        b.disabled = true;
                        b.classList.add("vote-btn-disabled");
                        b.classList.remove("voted");
                    });
                    if (pendingButton) {
                        pendingButton.classList.add("voted");
                    }

                    const result = document.querySelector(".vote-result");
                    if (result) {
                        result.textContent =
                            'আপনি "' + pendingCandidateName +
                            '" কে ভোট দিয়েছেন। এই ডিভাইস থেকে আর ভোট দেওয়া যাবে না।';
                    }

                    setTimeout(() => overlay.classList.remove("show"), 900);
                }, 1200);
            });

            cancelBtn.addEventListener("click", function () {
                overlay.classList.remove("show");
            });
        }

        // =========================
        //   INIT
        // =========================
        document.addEventListener("DOMContentLoaded", function () {
            initPreviousVoteState();
            loadVotes();
            setupVoteButtons();
            setupFingerprintPopup();

            // চাইলে অটো রিফ্রেশ:
            // setInterval(loadVotes, 5000);
        });
    </script>
</body>
</html>
